<!DOCTYPE html>
<html>
<head>
    <title>Dashboard</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <style>
        :root { --mnu-maroon: #8b1d22; }
        body { font-family: sans-serif; margin:0; background:#f4f4f4; }
        nav { background: var(--mnu-maroon); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; }        
        .container { padding:20px; display:flex; gap:20px; flex-wrap:wrap; }
        a { color: white; text-decoration: none; font-weight: bold; display: flex; align-items: center; }
      
        .card { 
            background:white; 
            width:280px; 
            height: 300px; 
            border-radius:8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden; 
            transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-5px); }

       
        .card-banner {
            height: 100px;
            width: 100%;
        }

        .card-body {
            padding: 15px;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

       
        .card h3 {
            margin: 0 0 10px 0;
            font-size: 1.2rem;
            height: 2.8em;        
            line-height: 1.3;     
            
            
            display: flex;
            align-items: center;  
            
          
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            
        
            justify-content: flex-start; 
            align-content: center;
        }

        .card p {
            margin: 5px 0;
            color: #555;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .btn { 
            background:#8b1d22; 
            color:white; 
            border:none; 
            padding:10px; 
            width:100%; 
            cursor:pointer; 
            margin-top: auto; 
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <nav style="background:#8b1d22; color:white; padding:15px; display:flex; justify-content:space-between; align-items:center;">
         <a href="index.html">
                <img src="Untitled.png" alt="Logo" style="height: 40px;"> 
                <span>LMS DASHBOARD</span>
        </a>

        
        <div id="navRight" style="display:flex; align-items:center;">
            <span id="uName" style="margin-right:15px; font-weight:bold;"></span>
            <button onclick="localStorage.clear(); location.href='login.html'" style="background:white; color:var(--mnu-maroon); border:none; padding:8px 15px; cursor:pointer; border-radius:4px; font-weight:bold;">Logout</button>
        </div>
    </nav>

    <div id="studentStats" style="display:none; background:white; padding:20px; margin:20px; border-radius:8px; border-left:10px solid #c5a059;">
        <h3 style="margin-top:0; color:#8b1d22;">My Academic Standing</h3>
        <div style="font-size:1.2rem;">
            Overall Average Score: <span id="gpaValue" style="font-weight:bold; color:green;">Calculating...</span> / 100
        </div>
    </div>

    <div class="container" id="list"></div>

    <script>
        function getBannerColor(title) {
            const colors = [
                '#1abc9c', '#2ecc71', '#3498db', '#9b59b6', '#34495e', 
                '#16a085', '#27ae60', '#2980b9', '#8e44ad', '#2c3e50', 
                '#f1c40f', '#e67e22', '#e74c3c', '#95a5a6', '#f39c12', 
                '#16a085', '#c0392b', '#7f8c8d'
            ];
            const firstLetterCode = title.toUpperCase().charCodeAt(0) || 0;
            const index = firstLetterCode % colors.length;
            return colors[index];
        }

        async function load() {
            const token = localStorage.getItem('token');
            const role = localStorage.getItem('role');
            const name = localStorage.getItem('name');

            if (!token) { window.location.href = 'login.html'; return; }

            document.getElementById('uName').innerText = name || "User";

            const navRight = document.getElementById('navRight');
            if (role === 'superadmin' && navRight) {
                if (!document.getElementById('superBtn')) {
                    const adminBtn = document.createElement('button');
                    adminBtn.id = "superBtn";
                    adminBtn.innerText = "✏️";
                    adminBtn.style.marginRight = "10px";
                    adminBtn.style.padding = "5px 15px";
                    adminBtn.style.cursor = "pointer";
                    adminBtn.onclick = () => location.href = 'superadmin.html';
                    navRight.prepend(adminBtn);
                }
            }

            if (role === 'user') {
                const statsBox = document.getElementById('studentStats');
                if (statsBox) statsBox.style.display = 'block';
                
                try {
                    const statsRes = await fetch('/api/enrollments/stats', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const stats = await statsRes.json();
                    if (stats && stats.length > 0) {
                        document.getElementById('gpaValue').innerText = stats[0].avg.toFixed(1);
                    } else {
                        document.getElementById('gpaValue').innerText = "No grades yet";
                    }
                } catch (err) { console.log("GPA failed to load"); }
            }

            try {
                const url = (role === 'admin' || role === 'superadmin') 
                            ? '/api/courses' 
                            : '/api/enrollments/my-courses';
                
                const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                const listDiv = document.getElementById('list');

                if (!data || data.length === 0) {
                    listDiv.innerHTML = "<h3>No courses assigned yet.</h3>";
                    return;
                }

                listDiv.innerHTML = data.map(item => {
                    const c = (role === 'admin' || role === 'superadmin') ? item : item.course_id;
                    if (!c) return '';
                    
                    let instructor = "Staff";
                    let category = c.category || "General";
                    if (role === 'admin') instructor = "You";
                    else if (c.teacher_id?.name) instructor = c.teacher_id.name;
                    const bannerColor = getBannerColor(c.title);

                    return `
                        <div class="card">
                            <div class="card-banner" style="background-color: ${bannerColor};"></div>
                            <div class="card-body">
                                <h3 title="${c.title}">${c.title}</h3>
                                <p><b>Instructor:</b> ${instructor}</p>
                                <p><b>Category:</b> ${category}</p>
                                <button class="btn" onclick="location.href='course.html?id=${c._id}'">
                                    Open Course
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (err) { console.error(err); }
        }

        load();
    </script>
</body>
</html>